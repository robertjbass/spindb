name: Windows Tests

on:
  # TODO: Remove push trigger after Windows tests pass once
  push:
    branches: [feature/windows]
  pull_request:
    branches: [main]
  workflow_dispatch: # Allows manual triggering from GitHub UI

jobs:
  test-unit:
    name: Unit Tests (Windows)
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run unit tests
        run: pnpm test:unit
        timeout-minutes: 15

  test-postgresql:
    name: PostgreSQL Tests (Windows)
    runs-on: windows-latest
    needs: test-unit
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Download PostgreSQL binaries
        run: pnpm start engines download postgresql 17

      - name: Add PostgreSQL to PATH
        shell: pwsh
        run: |
          # EDB binaries are downloaded to ~/.spindb/bin/postgresql-{version}-win32-x64/bin
          $pgPath = "$env:USERPROFILE\.spindb\bin\postgresql-17.7.0-win32-x64\bin"
          if (Test-Path $pgPath) {
            echo "$pgPath" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
            echo "Found PostgreSQL at: $pgPath"
          } else {
            echo "ERROR: PostgreSQL binaries not found at $pgPath"
            Get-ChildItem "$env:USERPROFILE\.spindb\bin" -ErrorAction SilentlyContinue
            exit 1
          }

      - name: Verify PostgreSQL tools
        run: |
          psql --version
          pg_dump --version

      - name: Run PostgreSQL tests
        run: pnpm test:pg
        timeout-minutes: 15

  test-mysql:
    name: MySQL Tests (Windows)
    runs-on: windows-latest
    needs: test-unit
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install MySQL
        run: choco install mysql -y

      - name: Add MySQL to PATH
        shell: pwsh
        run: |
          # MySQL installs to various locations, find it
          $possiblePaths = @(
            "C:\tools\mysql\current\bin",
            "C:\Program Files\MySQL\MySQL Server 8.0\bin",
            "C:\Program Files\MySQL\MySQL Server 8.4\bin"
          )
          foreach ($path in $possiblePaths) {
            if (Test-Path $path) {
              echo "$path" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
              break
            }
          }

      - name: Verify MySQL tools
        run: |
          mysql --version
          mysqld --version

      - name: Run MySQL tests
        run: pnpm test:mysql
        timeout-minutes: 15

  test-sqlite:
    name: SQLite Tests (Windows)
    runs-on: windows-latest
    needs: test-unit
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install SQLite
        run: choco install sqlite -y

      - name: Add SQLite to PATH
        shell: pwsh
        run: |
          $sqlitePath = "C:\ProgramData\chocolatey\lib\SQLite\tools"
          if (Test-Path $sqlitePath) {
            echo "$sqlitePath" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          }

      - name: Verify SQLite
        run: sqlite3 --version

      - name: Run SQLite tests
        run: pnpm test:sqlite
        timeout-minutes: 15
