name: Windows Tests

on:
  # TODO: Remove push trigger after Windows tests pass once
  push:
    branches: [feature/windows]
  pull_request:
    branches: [main]
  workflow_dispatch: # Allows manual triggering from GitHub UI

jobs:
  test-unit:
    name: Unit Tests (Windows)
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run unit tests
        run: pnpm test:unit
        timeout-minutes: 15

  test-postgresql:
    name: PostgreSQL Tests (Windows)
    runs-on: windows-latest
    needs: test-unit
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install PostgreSQL client tools
        run: choco install postgresql --params '/Password:postgres' -y

      - name: Add PostgreSQL to PATH
        shell: pwsh
        run: |
          $pgPath = "C:\Program Files\PostgreSQL\17\bin"
          if (Test-Path $pgPath) {
            echo "$pgPath" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          } else {
            # Try finding PostgreSQL in other locations
            $versions = @("17", "16", "15", "14")
            foreach ($v in $versions) {
              $path = "C:\Program Files\PostgreSQL\$v\bin"
              if (Test-Path $path) {
                echo "$path" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
                break
              }
            }
          }

      - name: Verify PostgreSQL tools
        run: |
          psql --version
          pg_dump --version

      - name: Run PostgreSQL tests
        run: pnpm test:pg
        timeout-minutes: 15

  test-mysql:
    name: MySQL Tests (Windows)
    runs-on: windows-latest
    needs: test-unit
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install MySQL
        run: choco install mysql -y

      - name: Add MySQL to PATH
        shell: pwsh
        run: |
          # MySQL installs to various locations, find it
          $possiblePaths = @(
            "C:\tools\mysql\current\bin",
            "C:\Program Files\MySQL\MySQL Server 8.0\bin",
            "C:\Program Files\MySQL\MySQL Server 8.4\bin"
          )
          foreach ($path in $possiblePaths) {
            if (Test-Path $path) {
              echo "$path" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
              break
            }
          }

      - name: Verify MySQL tools
        run: |
          mysql --version
          mysqld --version

      - name: Run MySQL tests
        run: pnpm test:mysql
        timeout-minutes: 15

  test-sqlite:
    name: SQLite Tests (Windows)
    runs-on: windows-latest
    needs: test-unit
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install SQLite
        run: choco install sqlite -y

      - name: Add SQLite to PATH
        shell: pwsh
        run: |
          $sqlitePath = "C:\ProgramData\chocolatey\lib\SQLite\tools"
          if (Test-Path $sqlitePath) {
            echo "$sqlitePath" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          }

      - name: Verify SQLite
        run: sqlite3 --version

      - name: Run SQLite tests
        run: pnpm test:sqlite
        timeout-minutes: 15
