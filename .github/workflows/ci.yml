name: CI

on:
  pull_request:
    branches: [main]
  # TODO - uncomment to test on dev branch push
  # push:
  #   branches: [dev]
  # TODO - delete before merging
  push:
    branches: [feature/valkey]
  workflow_dispatch:

# =============================================================================
# OS Coverage Strategy
# =============================================================================
# We test on 5 OS variants to cover different platforms and architectures:
#   - ubuntu-22.04 (x64) - LTS with older glibc/system libraries
#   - ubuntu-24.04 (x64) - LTS with newer libraries (catches issues like libaio rename)
#   - macos-15 (Intel x64) - Sequoia
#   - macos-14 (ARM64/Apple Silicon) - Sonoma
#   - windows-latest (x64)
#
# Note: We test two Ubuntu versions instead of Linux ARM64 because:
#   1. GitHub Actions doesn't offer free native Linux ARM64 runners
#   2. QEMU emulation is too slow and flaky for CI
#   3. Two Ubuntu LTS versions catch real library compatibility issues
#   4. macOS ARM64 validates ARM code paths
#   5. A commented-out ARM64 job exists below if native runners become available
# =============================================================================

# Cancel in-progress runs when a new run is triggered
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================
  # Unit Tests - Expanded OS Matrix
  # Tests on multiple OS versions to catch platform-specific issues
  # ============================================
  unit-tests:
    name: Unit Tests (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-22.04
          - ubuntu-24.04
          - macos-15 # Intel
          - macos-14 # ARM64
          - windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run unit tests
        run: pnpm test:unit
        timeout-minutes: 10

  # ============================================
  # Lint and Type Check - Runs in parallel with unit tests
  # ============================================
  lint:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run lint
        run: pnpm lint

  # ============================================
  # hostdb Version Sync Check
  # Verifies SpinDB version-maps match hostdb releases.json
  # ============================================
  hostdb-sync:
    name: Verify hostdb Sync
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Verify version maps match hostdb
        run: pnpm test:hostdb-sync

  # ============================================
  # PostgreSQL Integration Tests
  # Uses SpinDB to download and manage PostgreSQL
  # ============================================
  test-postgresql:
    name: PostgreSQL (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-22.04
          - ubuntu-24.04
          - macos-15 # Intel
          - macos-14 # ARM64
          - windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # Cache PostgreSQL binaries - these are ~100MB+ downloads
      - name: Cache PostgreSQL binaries
        uses: actions/cache@v4
        id: pg-cache
        with:
          path: ~/.spindb/bin
          key: spindb-pg-18-${{ runner.os }}-${{ runner.arch }}

      # Use SpinDB to download PostgreSQL binaries
      # NOTE: Keep this version in sync with config/engine-defaults.ts defaultVersion
      # See CLAUDE.md "Updating Supported Engine Versions" when changing
      - name: Install PostgreSQL via SpinDB
        run: pnpm start engines download postgresql 18

      # Show what SpinDB installed
      - name: Show installed engines
        run: pnpm start engines list

      - name: Run PostgreSQL integration tests
        run: pnpm test:pg
        timeout-minutes: 15

  # ============================================
  # MariaDB Integration Tests
  # Uses SpinDB to download and manage MariaDB binaries (like PostgreSQL)
  # ============================================
  test-mariadb:
    name: MariaDB (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-22.04
          - ubuntu-24.04
          - macos-15 # Intel
          - macos-14 # ARM64
          - windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # Cache MariaDB binaries - these are ~100MB+ downloads
      - name: Cache MariaDB binaries
        uses: actions/cache@v4
        id: mariadb-cache
        with:
          path: ~/.spindb/bin
          key: spindb-mariadb-11.8-${{ runner.os }}-${{ runner.arch }}

      # Use SpinDB to download MariaDB binaries
      - name: Install MariaDB via SpinDB
        run: pnpm start engines download mariadb 11.8

      # Show what SpinDB installed
      - name: Show installed engines
        run: pnpm start engines list

      - name: Run MariaDB integration tests
        run: pnpm test:mariadb
        timeout-minutes: 15

  # ============================================
  # MySQL Integration Tests
  # Uses SpinDB to download and manage MySQL binaries (like PostgreSQL)
  # ============================================
  test-mysql:
    name: MySQL (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-22.04
          - ubuntu-24.04
          - macos-15 # Intel
          - macos-14 # ARM64
          - windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # MySQL requires libaio on Linux
      # Ubuntu 22.04 uses libaio1, Ubuntu 24.04 uses libaio1t64 with renamed library
      - name: Install libaio (Linux only)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          # Try libaio1 first (Ubuntu 22.04), fall back to libaio1t64 (Ubuntu 24.04)
          if sudo apt-get install -y libaio1 2>/dev/null; then
            echo "Installed libaio1"
          else
            sudo apt-get install -y libaio1t64
            # Create symlink for MySQL which expects libaio.so.1
            if [ -e /lib/x86_64-linux-gnu/libaio.so.1t64 ]; then
              sudo ln -sf /lib/x86_64-linux-gnu/libaio.so.1t64 /lib/x86_64-linux-gnu/libaio.so.1
            fi
            echo "Installed libaio1t64 with symlink"
          fi

      # Cache MySQL binaries - these are ~100MB+ downloads
      - name: Cache MySQL binaries
        uses: actions/cache@v4
        id: mysql-cache
        with:
          path: ~/.spindb/bin
          key: spindb-mysql-9-${{ runner.os }}-${{ runner.arch }}

      # Use SpinDB to download MySQL binaries
      - name: Install MySQL via SpinDB
        run: pnpm start engines download mysql 9

      # Show what SpinDB installed
      - name: Show installed engines
        run: pnpm start engines list

      - name: Run MySQL integration tests
        run: pnpm test:mysql
        timeout-minutes: 15

  # ============================================
  # SQLite Integration Tests
  # Uses SpinDB to download and manage SQLite binaries from hostdb
  # ============================================
  test-sqlite:
    name: SQLite (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-22.04
          - ubuntu-24.04
          - macos-15 # Intel
          - macos-14 # ARM64
          - windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # Cache SQLite binaries - these are downloaded from hostdb
      - name: Cache SQLite binaries
        uses: actions/cache@v4
        id: sqlite-cache
        with:
          path: ~/.spindb/bin
          key: spindb-sqlite-3-${{ runner.os }}-${{ runner.arch }}

      # Use SpinDB to download SQLite binaries (all platforms)
      - name: Install SQLite via SpinDB
        run: pnpm start engines download sqlite 3

      - name: Show installed engines
        run: pnpm start engines list

      - name: Run SQLite integration tests
        run: pnpm test:sqlite
        timeout-minutes: 10

  # ============================================
  # MongoDB Integration Tests
  # Uses SpinDB to download and manage MongoDB binaries from hostdb
  # ============================================
  test-mongodb:
    name: MongoDB (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-22.04
          - ubuntu-24.04
          - macos-15 # Intel
          - macos-14 # ARM64
          - windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # Cache MongoDB binaries - these are downloaded from hostdb
      - name: Cache MongoDB binaries
        uses: actions/cache@v4
        id: mongodb-cache
        with:
          path: ~/.spindb/bin
          key: spindb-mongodb-8.0-${{ runner.os }}-${{ runner.arch }}

      # Download MongoDB binaries via hostdb for all platforms
      - name: Download MongoDB binaries
        run: pnpm start engines download mongodb 8.0

      - name: Show installed engines
        run: pnpm start engines list

      - name: Run MongoDB integration tests
        run: pnpm test:mongodb
        timeout-minutes: 15

  # ============================================
  # Redis Integration Tests
  # Uses SpinDB to download and manage Redis binaries from hostdb
  # ============================================
  test-redis:
    name: Redis (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-22.04
          - ubuntu-24.04
          - macos-15 # Intel
          - macos-14 # ARM64
          - windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # Cache Redis binaries - these are downloaded from hostdb
      # Cache key includes version suffix to bust cache when extraction logic changes
      - name: Cache Redis binaries
        uses: actions/cache@v4
        id: redis-cache
        with:
          path: ~/.spindb/bin
          key: spindb-redis-8-v5-${{ runner.os }}-${{ runner.arch }}

      # Use SpinDB to download Redis binaries (all platforms)
      - name: Install Redis via SpinDB
        run: pnpm start engines download redis 8

      - name: Show installed engines
        run: pnpm start engines list

      - name: Run Redis integration tests
        run: pnpm test:redis
        timeout-minutes: 15

      - name: Show Redis logs on failure (Windows)
        if: failure() && runner.os == 'Windows'
        shell: pwsh
        run: |
          Write-Host "=== Redis container directories ==="
          Get-ChildItem -Path "$env:USERPROFILE\.spindb\containers\redis" -Recurse -ErrorAction SilentlyContinue | Select-Object FullName
          Write-Host ""
          Write-Host "=== Redis binary directory ==="
          Get-ChildItem -Path "$env:USERPROFILE\.spindb\bin" -Recurse -ErrorAction SilentlyContinue | Where-Object { $_.Name -like "redis*" } | Select-Object FullName
          Write-Host ""
          Write-Host "=== Redis log files ==="
          Get-ChildItem -Path "$env:USERPROFILE\.spindb\containers\redis" -Filter "*.log" -Recurse -ErrorAction SilentlyContinue | ForEach-Object {
            Write-Host "--- $($_.FullName) ---"
            Get-Content $_.FullName -ErrorAction SilentlyContinue
          }
          Write-Host ""
          Write-Host "=== Redis config files ==="
          Get-ChildItem -Path "$env:USERPROFILE\.spindb\containers\redis" -Filter "*.conf" -Recurse -ErrorAction SilentlyContinue | ForEach-Object {
            Write-Host "--- $($_.FullName) ---"
            Get-Content $_.FullName -ErrorAction SilentlyContinue
          }

  # ============================================
  # Valkey Integration Tests
  # Uses SpinDB to download and manage Valkey binaries from hostdb
  # ============================================
  test-valkey:
    name: Valkey (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-22.04
          - ubuntu-24.04
          - macos-15 # Intel
          - macos-14 # ARM64
          - windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # Cache Valkey binaries - these are downloaded from hostdb
      # Cache key includes version suffix to bust cache when extraction logic changes
      - name: Cache Valkey binaries
        uses: actions/cache@v4
        id: valkey-cache
        with:
          path: ~/.spindb/bin
          key: spindb-valkey-9-v5-${{ runner.os }}-${{ runner.arch }}

      # Use SpinDB to download Valkey binaries (all platforms)
      - name: Install Valkey via SpinDB
        run: pnpm start engines download valkey 9

      - name: Show installed engines
        run: pnpm start engines list

      - name: Run Valkey integration tests
        run: pnpm test:valkey
        timeout-minutes: 15

      - name: Show Valkey logs on failure (Windows)
        if: failure() && runner.os == 'Windows'
        shell: pwsh
        run: |
          Write-Host "=== Valkey container directories ==="
          Get-ChildItem -Path "$env:USERPROFILE\.spindb\containers\valkey" -Recurse -ErrorAction SilentlyContinue | Select-Object FullName
          Write-Host ""
          Write-Host "=== Valkey binary directory ==="
          Get-ChildItem -Path "$env:USERPROFILE\.spindb\bin" -Recurse -ErrorAction SilentlyContinue | Where-Object { $_.Name -like "valkey*" } | Select-Object FullName
          Write-Host ""
          Write-Host "=== Valkey log files ==="
          Get-ChildItem -Path "$env:USERPROFILE\.spindb\containers\valkey" -Filter "*.log" -Recurse -ErrorAction SilentlyContinue | ForEach-Object {
            Write-Host "--- $($_.FullName) ---"
            Get-Content $_.FullName -ErrorAction SilentlyContinue
          }
          Write-Host ""
          Write-Host "=== Valkey config files ==="
          Get-ChildItem -Path "$env:USERPROFILE\.spindb\containers\valkey" -Filter "*.conf" -Recurse -ErrorAction SilentlyContinue | ForEach-Object {
            Write-Host "--- $($_.FullName) ---"
            Get-Content $_.FullName -ErrorAction SilentlyContinue
          }

  # ============================================
  # CLI End-to-End Tests (PostgreSQL + SQLite)
  # ============================================
  test-cli-e2e:
    name: CLI E2E (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-22.04
          - ubuntu-24.04
          - macos-15 # Intel
          - macos-14 # ARM64
          - windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # Cache PostgreSQL and SQLite binaries - these are downloads from hostdb
      - name: Cache binaries
        uses: actions/cache@v4
        id: binaries-cache
        with:
          path: ~/.spindb/bin
          key: spindb-cli-e2e-pg18-sqlite3-${{ runner.os }}-${{ runner.arch }}

      # Use SpinDB to install all required engines
      # NOTE: Keep PostgreSQL version in sync with config/engine-defaults.ts defaultVersion
      - name: Install PostgreSQL via SpinDB
        run: pnpm start engines download postgresql 18

      - name: Install SQLite via SpinDB
        run: pnpm start engines download sqlite 3

      - name: Show installed engines
        run: pnpm start engines list

      - name: Run CLI E2E tests
        run: pnpm test:cli
        timeout-minutes: 15

  # ============================================
  # Fresh Install Test - Tests npm global install like real users
  # Simulates a user installing SpinDB for the first time
  # ============================================
  test-fresh-install:
    name: Fresh Install (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-24.04
          - macos-14 # ARM64
          - windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      # Ensure clean state - no existing ~/.spindb
      - name: Ensure clean state (Unix)
        if: runner.os != 'Windows'
        run: rm -rf ~/.spindb

      - name: Ensure clean state (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          if (Test-Path "$env:USERPROFILE\.spindb") {
            Remove-Item -Recurse -Force "$env:USERPROFILE\.spindb"
          }

      # Pack and install globally (simulates npm install -g spindb)
      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Pack package
        run: pnpm pack

      - name: Install globally (Unix)
        if: runner.os != 'Windows'
        run: npm install -g spindb-*.tgz

      - name: Install globally (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: npm install -g (Get-Item spindb-*.tgz).FullName

      # Test CLI is accessible
      - name: Verify spindb command exists
        run: spindb version

      - name: Verify spindb help works
        run: spindb --help

      # Test full lifecycle with PostgreSQL
      - name: Download PostgreSQL engine
        run: spindb engines download postgresql 18

      - name: List installed engines
        run: spindb engines list

      - name: Create test container
        run: spindb create fresh-install-test --engine postgresql --db-version 18 --no-start

      - name: Start container
        run: spindb start fresh-install-test

      - name: Verify container is running
        run: spindb info fresh-install-test

      - name: Run test query
        run: spindb run fresh-install-test -c "SELECT 1 as test;"

      - name: Stop container
        run: spindb stop fresh-install-test

      - name: Delete container
        run: spindb delete fresh-install-test --yes

      # Cleanup
      - name: Uninstall spindb
        run: npm uninstall -g spindb

  # ============================================
  # Upgrade Test - Tests that existing containers survive upgrades
  # Simulates a user upgrading SpinDB with existing data
  # ============================================
  test-upgrade:
    name: Upgrade Test (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-24.04
          - macos-14 # ARM64
          - windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      # Ensure clean state
      - name: Ensure clean state (Unix)
        if: runner.os != 'Windows'
        run: rm -rf ~/.spindb

      - name: Ensure clean state (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          if (Test-Path "$env:USERPROFILE\.spindb") {
            Remove-Item -Recurse -Force "$env:USERPROFILE\.spindb"
          }

      # Install current version
      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Pack and install globally
        shell: bash
        run: |
          pnpm pack
          npm install -g spindb-*.tgz

      # Create container and add data
      - name: Download PostgreSQL engine
        run: spindb engines download postgresql 18

      - name: Create container with data
        run: |
          spindb create upgrade-test --engine postgresql --db-version 18 --no-start
          spindb start upgrade-test

      - name: Add test data
        shell: bash
        run: |
          spindb run upgrade-test -c "CREATE TABLE upgrade_data (id SERIAL PRIMARY KEY, value TEXT);"
          spindb run upgrade-test -c "INSERT INTO upgrade_data (value) VALUES ('pre-upgrade-data');"

      - name: Verify data exists
        run: spindb run upgrade-test -c "SELECT * FROM upgrade_data;"

      - name: Stop container
        run: spindb stop upgrade-test

      # Simulate upgrade by reinstalling
      - name: Uninstall current version
        run: npm uninstall -g spindb

      - name: Reinstall (simulate upgrade)
        shell: bash
        run: npm install -g spindb-*.tgz

      # Verify data persists after upgrade
      - name: Verify spindb still works
        run: spindb version

      - name: List containers (should show upgrade-test)
        run: spindb list

      - name: Start container after upgrade
        run: spindb start upgrade-test

      - name: Verify data persisted
        run: spindb run upgrade-test -c "SELECT * FROM upgrade_data WHERE value = 'pre-upgrade-data';"

      # Cleanup
      - name: Stop and delete container
        run: |
          spindb stop upgrade-test
          spindb delete upgrade-test --yes

      - name: Uninstall spindb
        run: npm uninstall -g spindb

  # ============================================
  # Docker Linux Edge Cases - Tests library dependencies on minimal Linux
  # Verifies hostdb binaries work on clean Ubuntu systems
  # ============================================
  test-docker-linux:
    name: Docker Linux Edge Cases
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build Docker test image
        run: docker build -t spindb-e2e -f tests/docker/Dockerfile .

      - name: Run Docker E2E tests
        run: docker run --rm spindb-e2e
        timeout-minutes: 30

  # ============================================
  # Linux ARM64 Tests (COMMENTED OUT)
  # ============================================
  # Uncomment this section if GitHub adds free ARM64 runners or if you have
  # access to paid larger runners. Native ARM64 is much faster than QEMU.
  #
  # To enable: uncomment the job below and add 'test-linux-arm64' to the
  # 'needs' array in the ci-success job at the bottom of this file.
  # ============================================
  #
  # test-linux-arm64:
  #   name: Linux ARM64 (${{ matrix.test }})
  #   # Native ARM64 runner (requires GitHub Teams/Enterprise or larger runners)
  #   runs-on: ubuntu-24.04-arm64
  #   strategy:
  #     fail-fast: false
  #     matrix:
  #       test:
  #         - unit
  #         - postgresql
  #         - mysql
  #         - mariadb
  #         - sqlite
  #         - mongodb
  #         - redis
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v4
  #
  #     - name: Setup pnpm
  #       uses: pnpm/action-setup@v4
  #
  #     - name: Setup Node.js
  #       uses: actions/setup-node@v4
  #       with:
  #         node-version: '22'
  #         cache: 'pnpm'
  #
  #     - name: Install dependencies
  #       run: pnpm install --frozen-lockfile
  #
  #     # Cache binaries for all engines
  #     - name: Cache binaries
  #       uses: actions/cache@v4
  #       with:
  #         path: ~/.spindb/bin
  #         key: spindb-arm64-${{ matrix.test }}-${{ runner.os }}-${{ runner.arch }}
  #
  #     # Download engine binaries based on test type
  #     - name: Download PostgreSQL
  #       if: matrix.test == 'postgresql' || matrix.test == 'unit'
  #       run: pnpm start engines download postgresql 18
  #
  #     - name: Download MySQL
  #       if: matrix.test == 'mysql'
  #       run: pnpm start engines download mysql 9
  #
  #     - name: Download MariaDB
  #       if: matrix.test == 'mariadb'
  #       run: pnpm start engines download mariadb 11.8
  #
  #     - name: Download SQLite
  #       if: matrix.test == 'sqlite'
  #       run: pnpm start engines download sqlite 3
  #
  #     - name: Download MongoDB
  #       if: matrix.test == 'mongodb'
  #       run: pnpm start engines download mongodb 8.0
  #
  #     - name: Download Redis
  #       if: matrix.test == 'redis'
  #       run: pnpm start engines download redis 8
  #
  #     - name: Show installed engines
  #       run: pnpm start engines list
  #
  #     # Run the appropriate test
  #     - name: Run unit tests
  #       if: matrix.test == 'unit'
  #       run: pnpm test:unit
  #       timeout-minutes: 10
  #
  #     - name: Run PostgreSQL tests
  #       if: matrix.test == 'postgresql'
  #       run: pnpm test:pg
  #       timeout-minutes: 15
  #
  #     - name: Run MySQL tests
  #       if: matrix.test == 'mysql'
  #       run: pnpm test:mysql
  #       timeout-minutes: 15
  #
  #     - name: Run MariaDB tests
  #       if: matrix.test == 'mariadb'
  #       run: pnpm test:mariadb
  #       timeout-minutes: 15
  #
  #     - name: Run SQLite tests
  #       if: matrix.test == 'sqlite'
  #       run: pnpm test:sqlite
  #       timeout-minutes: 10
  #
  #     - name: Run MongoDB tests
  #       if: matrix.test == 'mongodb'
  #       run: pnpm test:mongodb
  #       timeout-minutes: 15
  #
  #     - name: Run Redis tests
  #       if: matrix.test == 'redis'
  #       run: pnpm test:redis
  #       timeout-minutes: 15

  # ============================================
  # Summary Job - Ensures all tests pass
  # ============================================
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs:
      [
        unit-tests,
        test-postgresql,
        test-mariadb,
        test-mysql,
        test-sqlite,
        test-mongodb,
        test-redis,
        test-valkey,
        test-cli-e2e,
        test-fresh-install,
        test-upgrade,
        test-docker-linux,
        lint,
        hostdb-sync,
      ]
    if: always()
    steps:
      - name: Check all jobs passed
        run: |
          if [ "${{ needs.unit-tests.result }}" != "success" ]; then
            echo "Unit tests failed"
            exit 1
          fi
          if [ "${{ needs.test-postgresql.result }}" != "success" ]; then
            echo "PostgreSQL tests failed"
            exit 1
          fi
          if [ "${{ needs.test-mariadb.result }}" != "success" ]; then
            echo "MariaDB tests failed"
            exit 1
          fi
          if [ "${{ needs.test-mysql.result }}" != "success" ]; then
            echo "MySQL tests failed"
            exit 1
          fi
          if [ "${{ needs.test-sqlite.result }}" != "success" ]; then
            echo "SQLite tests failed"
            exit 1
          fi
          if [ "${{ needs.test-mongodb.result }}" != "success" ]; then
            echo "MongoDB tests failed"
            exit 1
          fi
          if [ "${{ needs.test-redis.result }}" != "success" ]; then
            echo "Redis tests failed"
            exit 1
          fi
          if [ "${{ needs.test-valkey.result }}" != "success" ]; then
            echo "Valkey tests failed"
            exit 1
          fi
          if [ "${{ needs.test-cli-e2e.result }}" != "success" ]; then
            echo "CLI E2E tests failed"
            exit 1
          fi
          if [ "${{ needs.test-fresh-install.result }}" != "success" ]; then
            echo "Fresh install tests failed"
            exit 1
          fi
          if [ "${{ needs.test-upgrade.result }}" != "success" ]; then
            echo "Upgrade tests failed"
            exit 1
          fi
          if [ "${{ needs.test-docker-linux.result }}" != "success" ]; then
            echo "Docker Linux edge case tests failed"
            exit 1
          fi
          if [ "${{ needs.lint.result }}" != "success" ]; then
            echo "Lint check failed"
            exit 1
          fi
          if [ "${{ needs.hostdb-sync.result }}" != "success" ]; then
            echo "hostdb sync check failed"
            exit 1
          fi
          echo "All CI checks passed!"
