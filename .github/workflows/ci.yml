name: CI

on:
  # TODO: uncomment for testing CI
  # push:
  #   branches: [dev]
  push:
    branches: [feature/redis] # TODO: remove when testing is complete
  pull_request:
    branches: [main]
  workflow_dispatch:

# Cancel in-progress runs when a new run is triggered
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================
  # Unit Tests
  # ============================================
  unit-tests:
    name: Unit Tests (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run unit tests
        run: pnpm test:unit
        timeout-minutes: 10

  # ============================================
  # Lint and Type Check - Runs in parallel with unit tests
  # ============================================
  lint:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run lint
        run: pnpm lint

  # ============================================
  # PostgreSQL Integration Tests
  # Uses SpinDB to download and manage PostgreSQL
  # ============================================
  test-postgresql:
    name: PostgreSQL (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # Cache PostgreSQL binaries - these are ~100MB+ downloads
      - name: Cache PostgreSQL binaries
        uses: actions/cache@v4
        id: pg-cache
        with:
          path: ~/.spindb/bin
          key: spindb-pg-18-${{ runner.os }}-${{ runner.arch }}

      # Use SpinDB to download PostgreSQL binaries
      # NOTE: Keep this version in sync with config/engine-defaults.ts defaultVersion
      # See CLAUDE.md "Updating Supported Engine Versions" when changing
      - name: Install PostgreSQL via SpinDB
        run: pnpm start engines download postgresql 18

      # Show what SpinDB installed
      - name: Show installed engines
        run: pnpm start engines list

      - name: Run PostgreSQL integration tests
        run: pnpm test:pg
        timeout-minutes: 15

  # ============================================
  # MySQL Integration Tests
  # Uses SpinDB to install MySQL via system package manager
  # Skipped on Linux due to permission issues with Ubuntu's MySQL package
  # ============================================
  test-mysql:
    name: MySQL (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        # Skip Linux due to MySQL permission issues with Ubuntu's package
        os: [macos-latest, windows-latest]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # NOTE: macOS MySQL caching removed - Homebrew dependencies (protobuf, zlib)
      # are dynamically linked and not included in Cellar cache, causing dyld errors.
      # Fresh install is more reliable than partial caching.

      # Cache Chocolatey packages for MySQL on Windows
      - name: Cache Chocolatey packages (Windows)
        if: runner.os == 'Windows'
        uses: actions/cache@v4
        with:
          path: |
            C:\ProgramData\chocolatey\lib\mysql
            C:\tools\mysql
          key: choco-mysql-${{ runner.os }}
          restore-keys: |
            choco-mysql-

      # Windows needs MySQL added to PATH BEFORE install check (for cache hits)
      - name: Add MySQL to PATH (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $possiblePaths = @(
            "C:\tools\mysql\current\bin",
            "C:\Program Files\MySQL\MySQL Server 8.0\bin",
            "C:\Program Files\MySQL\MySQL Server 8.4\bin",
            "C:\Program Files\MySQL\MySQL Server 9.0\bin"
          )
          foreach ($path in $possiblePaths) {
            if (Test-Path $path) {
              echo "$path" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
              echo "Added MySQL to PATH: $path"
              break
            }
          }

      # Use SpinDB to install MySQL via system package manager
      - name: Install MySQL via SpinDB
        run: pnpm start engines download mysql

      - name: Show installed engines
        run: pnpm start engines list

      - name: Run MySQL integration tests
        run: pnpm test:mysql
        timeout-minutes: 15

  # ============================================
  # SQLite Integration Tests
  # Uses SpinDB to install SQLite via system package manager
  # ============================================
  test-sqlite:
    name: SQLite (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # Cache Chocolatey packages for SQLite on Windows
      - name: Cache Chocolatey packages (Windows)
        if: runner.os == 'Windows'
        uses: actions/cache@v4
        with:
          path: C:\ProgramData\chocolatey\lib\SQLite
          key: choco-sqlite-${{ runner.os }}
          restore-keys: |
            choco-sqlite-

      # Windows needs SQLite added to PATH BEFORE install check (for cache hits)
      - name: Add SQLite to PATH (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $sqlitePath = "C:\ProgramData\chocolatey\lib\SQLite\tools"
          if (Test-Path $sqlitePath) {
            echo "$sqlitePath" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
            echo "Added SQLite to PATH: $sqlitePath"
          }

      # Use SpinDB to install SQLite via system package manager
      - name: Install SQLite via SpinDB
        run: pnpm start engines download sqlite

      - name: Show installed engines
        run: pnpm start engines list

      - name: Run SQLite integration tests
        run: pnpm test:sqlite
        timeout-minutes: 10

  # ============================================
  # MongoDB Integration Tests
  # Uses system-installed MongoDB via Homebrew/apt/Chocolatey
  # ============================================
  test-mongodb:
    name: MongoDB (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # Install MongoDB on macOS via Homebrew
      - name: Install MongoDB (macOS)
        if: runner.os == 'macOS'
        run: |
          brew tap mongodb/brew
          brew install mongodb-community mongosh mongodb-database-tools

      # Install MongoDB on Ubuntu
      - name: Install MongoDB (Linux)
        if: runner.os == 'Linux'
        run: |
          # Import MongoDB public GPG key
          curl -fsSL https://www.mongodb.org/static/pgp/server-8.0.asc | \
            sudo gpg -o /usr/share/keyrings/mongodb-server-8.0.gpg --dearmor
          # Add MongoDB repository
          echo "deb [ signed-by=/usr/share/keyrings/mongodb-server-8.0.gpg ] https://repo.mongodb.org/apt/ubuntu jammy/mongodb-org/8.0 multiverse" | \
            sudo tee /etc/apt/sources.list.d/mongodb-org-8.0.list
          # Update and install
          sudo apt-get update
          sudo apt-get install -y mongodb-org mongodb-mongosh mongodb-database-tools

      # Cache Chocolatey packages for MongoDB on Windows
      - name: Cache Chocolatey packages (Windows)
        if: runner.os == 'Windows'
        uses: actions/cache@v4
        with:
          path: |
            C:\ProgramData\chocolatey\lib\mongodb
            C:\ProgramData\chocolatey\lib\mongodb-shell
            C:\ProgramData\chocolatey\lib\mongodb-database-tools
            C:\Program Files\MongoDB
          key: choco-mongodb-${{ runner.os }}-v1
          restore-keys: |
            choco-mongodb-${{ runner.os }}-

      # Windows needs MongoDB added to PATH BEFORE install check (for cache hits)
      - name: Add MongoDB to PATH (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $possibleServerPaths = @(
            "C:\Program Files\MongoDB\Server\8.0\bin",
            "C:\Program Files\MongoDB\Server\7.0\bin",
            "C:\Program Files\MongoDB\Server\6.0\bin"
          )
          $possibleToolsPaths = @(
            "C:\Program Files\MongoDB\Tools\100\bin",
            "C:\ProgramData\chocolatey\lib\mongodb-database-tools\tools"
          )
          foreach ($path in $possibleServerPaths) {
            if (Test-Path $path) {
              echo "$path" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
              echo "Added MongoDB Server to PATH: $path"
              break
            }
          }
          foreach ($path in $possibleToolsPaths) {
            if (Test-Path $path) {
              echo "$path" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
              echo "Added MongoDB Tools to PATH: $path"
              break
            }
          }

      # Install MongoDB on Windows via Chocolatey
      - name: Install MongoDB (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          # Check if MongoDB is already installed (cache hit)
          $mongodExists = Get-Command mongod -ErrorAction SilentlyContinue
          if (-not $mongodExists) {
            echo "Installing MongoDB via Chocolatey..."
            choco install mongodb --yes --no-progress
          } else {
            echo "MongoDB already installed (cache hit)"
          }

          # Check if mongosh is already installed
          $mongoshExists = Get-Command mongosh -ErrorAction SilentlyContinue
          if (-not $mongoshExists) {
            echo "Installing mongosh via Chocolatey..."
            choco install mongodb-shell --yes --no-progress
          } else {
            echo "mongosh already installed (cache hit)"
          }

          # Check if mongodump is already installed
          $mongodumpExists = Get-Command mongodump -ErrorAction SilentlyContinue
          if (-not $mongodumpExists) {
            echo "Installing mongodb-database-tools via Chocolatey..."
            choco install mongodb-database-tools --yes --no-progress
          } else {
            echo "mongodb-database-tools already installed (cache hit)"
          }

          # Re-add paths after install (in case they were just created)
          $possibleServerPaths = @(
            "C:\Program Files\MongoDB\Server\8.0\bin",
            "C:\Program Files\MongoDB\Server\7.0\bin",
            "C:\Program Files\MongoDB\Server\6.0\bin"
          )
          $possibleToolsPaths = @(
            "C:\Program Files\MongoDB\Tools\100\bin",
            "C:\ProgramData\chocolatey\lib\mongodb-database-tools\tools"
          )
          foreach ($path in $possibleServerPaths) {
            if (Test-Path $path) {
              echo "$path" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
              break
            }
          }
          foreach ($path in $possibleToolsPaths) {
            if (Test-Path $path) {
              echo "$path" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
              break
            }
          }

      # Verify MongoDB binaries are usable after install
      - name: Verify MongoDB installation (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Write-Host "Verifying MongoDB installation..."
          try {
            $mongodVersion = mongod --version | Select-Object -First 1
            Write-Host "✓ mongod: $mongodVersion"
          } catch {
            Write-Host "✗ mongod not found or not working"
            exit 1
          }
          try {
            $mongoshVersion = mongosh --version
            Write-Host "✓ mongosh: $mongoshVersion"
          } catch {
            Write-Host "✗ mongosh not found or not working"
            exit 1
          }
          try {
            $mongodumpVersion = mongodump --version | Select-Object -First 1
            Write-Host "✓ mongodump: $mongodumpVersion"
          } catch {
            Write-Host "✗ mongodump not found or not working"
            exit 1
          }
          Write-Host "All MongoDB binaries verified successfully"

      - name: Show installed engines
        run: pnpm start engines list

      - name: Run MongoDB integration tests
        run: pnpm test:mongodb
        timeout-minutes: 15

  # ============================================
  # Redis Integration Tests
  # Uses system-installed Redis via Homebrew/apt/Chocolatey
  # ============================================
  test-redis:
    name: Redis (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # Install Redis on macOS via Homebrew
      - name: Install Redis (macOS)
        if: runner.os == 'macOS'
        run: brew install redis

      # Install Redis on Ubuntu
      - name: Install Redis (Linux)
        if: runner.os == 'Linux'
        run: sudo apt-get update && sudo apt-get install -y redis-server redis-tools

      # Install Redis on Windows from tporadowski/redis GitHub releases
      # (official Redis doesn't support Windows, this is the most maintained port)
      - name: Cache Redis (Windows)
        if: runner.os == 'Windows'
        uses: actions/cache@v4
        id: redis-cache
        with:
          path: C:\Redis
          key: redis-windows-5.0.14.1

      - name: Install Redis (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          if (Test-Path "C:\Redis\redis-server.exe") {
            Write-Host "Redis already installed (cache hit)"
          } else {
            Write-Host "Downloading Redis for Windows from tporadowski/redis..."
            $url = "https://github.com/tporadowski/redis/releases/download/v5.0.14.1/Redis-x64-5.0.14.1.zip"
            $zip = "$env:TEMP\redis.zip"

            Invoke-WebRequest -Uri $url -OutFile $zip -UseBasicParsing

            Write-Host "Extracting to C:\Redis..."
            Expand-Archive -Path $zip -DestinationPath "C:\Redis" -Force
            Remove-Item $zip
          }

          # Add to PATH for subsequent steps
          echo "C:\Redis" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Verify Redis (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Write-Host "Verifying Redis installation..."
          redis-server --version
          redis-cli --version
          Write-Host "Redis installation verified successfully"

      - name: Show installed engines
        run: pnpm start engines list

      - name: Run Redis integration tests
        run: pnpm test:redis
        timeout-minutes: 15

  # ============================================
  # CLI End-to-End Tests (PostgreSQL + SQLite)
  # ============================================
  test-cli-e2e:
    name: CLI E2E (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # Cache PostgreSQL binaries - these are ~100MB+ downloads
      - name: Cache PostgreSQL binaries
        uses: actions/cache@v4
        id: pg-cache
        with:
          path: ~/.spindb/bin
          key: spindb-pg-18-${{ runner.os }}-${{ runner.arch }}

      # Cache Chocolatey packages for SQLite on Windows
      - name: Cache Chocolatey packages (Windows)
        if: runner.os == 'Windows'
        uses: actions/cache@v4
        with:
          path: C:\ProgramData\chocolatey\lib\SQLite
          key: choco-sqlite-${{ runner.os }}
          restore-keys: |
            choco-sqlite-

      # Windows needs SQLite added to PATH BEFORE install check (for cache hits)
      - name: Add SQLite to PATH (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $sqlitePath = "C:\ProgramData\chocolatey\lib\SQLite\tools"
          if (Test-Path $sqlitePath) {
            echo "$sqlitePath" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
            echo "Added SQLite to PATH: $sqlitePath"
          }

      # Use SpinDB to install all required engines
      # NOTE: Keep PostgreSQL version in sync with config/engine-defaults.ts defaultVersion
      - name: Install PostgreSQL via SpinDB
        run: pnpm start engines download postgresql 18

      - name: Install SQLite via SpinDB
        run: pnpm start engines download sqlite

      - name: Show installed engines
        run: pnpm start engines list

      - name: Run CLI E2E tests
        run: pnpm test:cli
        timeout-minutes: 15

  # ============================================
  # Summary Job - Ensures all tests pass
  # ============================================
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs:
      [
        unit-tests,
        test-postgresql,
        test-mysql,
        test-sqlite,
        test-mongodb,
        test-redis,
        test-cli-e2e,
        lint,
      ]
    if: always()
    steps:
      - name: Check all jobs passed
        run: |
          if [ "${{ needs.unit-tests.result }}" != "success" ]; then
            echo "Unit tests failed"
            exit 1
          fi
          if [ "${{ needs.test-postgresql.result }}" != "success" ]; then
            echo "PostgreSQL tests failed"
            exit 1
          fi
          if [ "${{ needs.test-mysql.result }}" != "success" ]; then
            echo "MySQL tests failed"
            exit 1
          fi
          if [ "${{ needs.test-sqlite.result }}" != "success" ]; then
            echo "SQLite tests failed"
            exit 1
          fi
          if [ "${{ needs.test-mongodb.result }}" != "success" ]; then
            echo "MongoDB tests failed"
            exit 1
          fi
          if [ "${{ needs.test-redis.result }}" != "success" ]; then
            echo "Redis tests failed"
            exit 1
          fi
          if [ "${{ needs.test-cli-e2e.result }}" != "success" ]; then
            echo "CLI E2E tests failed"
            exit 1
          fi
          if [ "${{ needs.lint.result }}" != "success" ]; then
            echo "Lint check failed"
            exit 1
          fi
          echo "All CI checks passed!"
