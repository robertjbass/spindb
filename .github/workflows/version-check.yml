name: Version Check

on:
  pull_request:
    branches: [main]

jobs:
  check-version:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4

      - name: Get PR version
        id: pr_version
        run: echo "version=$(node -p "require('./package.json').version")" >> $GITHUB_OUTPUT

      - name: Get npm version
        id: npm_version
        run: |
          NPM_VERSION=$(npm view spindb version 2>/dev/null || echo "0.0.0")
          echo "version=$NPM_VERSION" >> $GITHUB_OUTPUT

      - name: Compare versions
        run: |
          PR_VERSION="${{ steps.pr_version.outputs.version }}"
          NPM_VERSION="${{ steps.npm_version.outputs.version }}"

          echo "PR version: $PR_VERSION"
          echo "npm version: $NPM_VERSION"

          RESULT=$(node -e "
            const semver = (v) => v.split('.').map(Number);
            const pr = semver('$PR_VERSION');
            const npm = semver('$NPM_VERSION');

            for (let i = 0; i < 3; i++) {
              if (pr[i] > npm[i]) { console.log('greater'); process.exit(0); }
              if (pr[i] < npm[i]) { console.log('lesser'); process.exit(0); }
            }
            console.log('equal');
          ")

          if [ "$RESULT" != "greater" ]; then
            echo "❌ Version must be incremented before merging"
            echo ""
            echo "Current npm version: $NPM_VERSION"
            echo "PR version: $PR_VERSION"
            echo ""
            echo "Please bump the version in package.json"
            exit 1
          fi

          echo "✅ Version check passed: $NPM_VERSION → $PR_VERSION"
