name: Version Check

on:
  pull_request:
    branches: [main]

jobs:
  check-version:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4

      - name: Get PR version
        id: pr_version
        run: echo "version=$(node -p "require('./package.json').version")" >> $GITHUB_OUTPUT

      - name: Get npm version
        id: npm_version
        run: |
          NPM_VERSION=$(npm view spindb version 2>/dev/null || echo "0.0.0")
          echo "version=$NPM_VERSION" >> $GITHUB_OUTPUT

      - name: Compare versions
        id: compare
        run: |
          PR_VERSION="${{ steps.pr_version.outputs.version }}"
          NPM_VERSION="${{ steps.npm_version.outputs.version }}"

          echo "PR version: $PR_VERSION"
          echo "npm version: $NPM_VERSION"

          RESULT=$(node -e "
            const semver = (v) => v.split('.').map(Number);
            const pr = semver('$PR_VERSION');
            const npm = semver('$NPM_VERSION');

            for (let i = 0; i < 3; i++) {
              if (pr[i] > npm[i]) { console.log('greater'); process.exit(0); }
              if (pr[i] < npm[i]) { console.log('lesser'); process.exit(0); }
            }
            console.log('equal');
          ")

          echo "result=$RESULT" >> $GITHUB_OUTPUT

      - name: Comment on PR if version not bumped
        if: steps.compare.outputs.result != 'greater'
        uses: actions/github-script@v7
        with:
          script: |
            const prVersion = '${{ steps.pr_version.outputs.version }}';
            const npmVersion = '${{ steps.npm_version.outputs.version }}';

            const body = `## ❌ Version Check Failed

            | Current npm | This PR |
            |-------------|---------|
            | \`${npmVersion}\` | \`${prVersion}\` |

            Please bump the version in \`package.json\` to be greater than \`${npmVersion}\` before merging.

            **Examples:**
            - Patch: \`${npmVersion.replace(/\d+$/, n => parseInt(n) + 1)}\`
            - Minor: \`${npmVersion.replace(/\.\d+\.\d+$/, (m) => { const [, minor] = m.split('.'); return \`.\${parseInt(minor) + 1}.0\`; })}\`
            - Major: \`${npmVersion.replace(/^\d+/, n => parseInt(n) + 1).replace(/\.\d+\.\d+$/, '.0.0')}\``;

            // Check if we already left a comment
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.data.find(c =>
              c.user.type === 'Bot' && c.body.includes('Version Check Failed')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body,
              });
            }

      - name: Fail if version not bumped
        if: steps.compare.outputs.result != 'greater'
        run: |
          echo "❌ Version must be incremented before merging"
          exit 1

      - name: Success
        if: steps.compare.outputs.result == 'greater'
        run: |
          echo "✅ Version check passed: ${{ steps.npm_version.outputs.version }} → ${{ steps.pr_version.outputs.version }}"
